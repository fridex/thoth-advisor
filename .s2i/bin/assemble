#!/usr/bin/bash
# Copyright(C) 2019 Fridolin Pokorny
# Adjusted assemble script to OpenShift s2i build.

set -ex

THOTH_ADVISER_BUILD_CACHE=${THOTH_ADVISER_BUILD_CACHE:-0}

if [[ ${THOTH_ADVISER_BUILD_CACHE} -eq 0 ]]; then
    exec /usr/libexec/s2i/assemble
else
    echo "---> Building graph cache..." >&2
    pushd /opt/app-root/src
    exec pipenv run thoth-storages restore-cache || true
    exec pipenv run thoth-storages create-cache
    exec pipenv run thoth-storages store-cache
fi
